<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>


    <%= stylesheet_link_tag "http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css", media: 'all' %>
    <%= stylesheet_link_tag "http://jqueryui.com/resources/demos/style.css", media: 'all' %>
    <%= javascript_include_tag "https://code.jquery.com/jquery-1.12.4.js" %>
    <%= javascript_include_tag "https://code.jquery.com/ui/1.12.1/jquery-ui.js" %>


    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
    displayAlign: "left",
    displayIndent: "2em",
    extensions: ["tex2jax.js"],
    messageStyle: "none",
    jax: ["input/TeX","output/HTML-CSS"],
    tex2jax: {
      inlineMath: [['$','$'],['\\[','\\]'],['\\(','\\)']],
      processEscapes: true
    },
    TeX: {
      equationNumbers: { autoNumber: "AMS" },
      Macros: {
        mbb: '\\mathbb',
        riff: '\\implies',
        liff: '\\impliedby',
        abs: ['\\left\\lvert #1\\right\\rvert', 1],
        rmd: '\\mathop{}\\!\\mathrm{d}',
        vv: '\\overrightarrow',
        sslash: '\\mathrel{/\\mkern-5mu/}',
        px: '\\mathrel{/\\mkern-5mu/}',
        pqd: '\\stackrel{\\,\\sslash}{\\raise-.5ex{=\\!\\!\\!\\!=}}',
        veps: '\\varepsilon',
        du: '^\\circ',
        bsb: '\\boldsymbol',
        bm: '\\boldsymbol',
        kongji: '\\varnothing',
        buji: '\\complement',
        S: ['S_{\\triangle #1}', 1],
        led: '\\left\\{\\begin{aligned}',
        endled: '\\end{aligned}\\right.',
        edr: '\\left.\\begin{aligned}',
        endedr: '\\end{aligned}\\right\\}',
        an: '\\{a_n\\}',
        bn: '\\{b_n\\}',
        cn: '\\{c_n\\}',
        xn: '\\{x_n\\}',
        Sn: '\\{S_n\\}',
        inR: '\\in\\mbb R',
        inN: '\\in\\mbb N',
        inZ: '\\in\\mbb Z',
        inC: '\\in\\mbb C',
        inQ: '\\in\\mbb Q',
        Rtt: '\\text{Rt}\\triangle'
      }
    },
    "HTML-CSS": {
      availableFonts:[],
      styles: {".MathJax_Preview": {visibility: "hidden"}}
    }
      });
    </script>

    <script type="text/javascript"
      src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>


    <style>
    label, input { display:block; }
    input.text { margin-bottom:12px; width:95%; padding: .4em; }
    fieldset { padding:0; border:0; margin-top:25px; }
    h1 { font-size: 1.2em; margin: .6em 0; }
    div#users-contain { width: 350px; margin: 20px 0; }
    div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
    div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
    .ui-dialog .ui-state-error { padding: .3em; }
    .validateTips { border: 1px solid transparent; padding: 0.3em; }
    </style>

  </head>

  <body class='<%= controller.controller_name %>'>
    <div id="banner">
      <%= image_tag("math_logo.jpeg", :size=>"130x45") %>
      <%= @page_title || "Math Playground" %>
    </div>
    <div id="columns">
      <div id="side">
    <ul>
      <li> <%= link_to "Home", problems_url %> </li>
      <li> <%= link_to "Problems", problems_url %> </li>
      <li> <%= link_to "KnowledgePoints", knowledge_points_url %> </li>
      <li> <%= link_to "Tags", tags_url %> </li>
      <li> <%= render 'layouts/nav_links_for_auth' %> </li>
      <li><a href="#">Contact</a></li>

    </ul>
      </div>
     <div id="main">
    <%= yield %>
     </div>
    </div>
    <footer> <%= @count %> </footer>
  </body>
</html>


<script>
  jQuery.expr[':'].regex = function(elem, index, match) {
      var matchParams = match[3].split(','),
      validLabels = /^(data|css):/,
      attr = {
          method: matchParams[0].match(validLabels) ?
              matchParams[0].split(':')[0] : 'attr',
          property: matchParams.shift().replace(validLabels,'')
      },
      regexFlags = 'ig',
      regex = new RegExp(matchParams.join('').replace(/^\s+|\s+$/g,''), regexFlags);
      return regex.test(jQuery(elem)[attr.method](attr.property));
  }

  //预览函数
  function doPreview()
  {
    var asdf = "";
    var origin_value = "";

    // var tags = document.getElementsByName("tags[]");
    var tags = $(':regex(id, ^tag_alias_text_[0-9]+)')
    // alert("found tags:" + tags.length)
    if (tags.length > 0) {
      asdf += "<br />";
      asdf += "Tag Description:<br />";
    }
    // var asdf = "";
    for (var index = 0; index < tags.length; index++) {

      var tag = tags[index].value
      origin_value = tag;
      // alert("mytag:" + tag)
      for (var i = 0; i < tag.length; i++)
      {
        switch(tag.charCodeAt(i))
        {
        case 10:
          asdf += "<br />";
          break;
        case 13:
          asdf += "<br />";
          break;
        case 60:
          asdf += "&lt;";
          break;
        case 62:
          asdf += "&gt;";
          break;
        default:
          asdf += tag.charAt(i);
        }
      }

      // alert("Hit me:" + index + " ==> " + asdf)
      var id = index + 1
      var output = 'tag_alias_output_' + id;
      var element = document.getElementById(output)
      element.innerHTML = origin_value;


      MathJax.Hub.Queue(["Typeset", MathJax.Hub, element]);
    }

    var output = 'output'
    if (document.getElementById(output) ) {
      document.getElementById(output).innerHTML = asdf;
      MathJax.Hub.Queue(["Typeset", MathJax.Hub, document.getElementById(output)]);
    }
    // MathJax.Hub.Queue(["Typeset",MathJax.Hub]);
  };


  window.onload = doPreview;
  // $(document).on("ready", function() {
  //   doPreview();
  // });


  function removeChoice(element) {
    var index = element.attr("id").substring(2)
    // alert("index removed:" + index)
    removeAnswerIndex(index)
    return element.parent().remove();
  };

  var index = 0;
  $("#addNewTag").on("click", function(e) {
    index = index + 1
    var value = $("#new_tag_content_form").html();

    value = value.replace(/myvar_/g, index)

    // alert("value:" + value)
    appendTagIndex(index);

    $("#tags").append(value)
    $("#tag_alias_text_" + index).keyup(doPreview);

  });


  function appendTagIndex(index) {
    var currentIndexes = $("#tag_indexes").val()
    if (index == 1) {
      currentIndexes = " " + index + " "
    } else {
      currentIndexes = currentIndexes + " " + index + " "
    }
    $("#tag_indexes").val(currentIndexes)


    // alert("indexes:" + currentIndexes)
  }

  function removeAnswerIndex(index) {
    var currentIndexes = $("#tag_indexes").val()
    currentIndexes = currentIndexes.replace(" " + index + " ", " ")
    $("#tag_indexes").val(currentIndexes)
    // alert("indexes:" + currentIndexes)
  }



  function populate_tag_form(data){
    // var children_kps = JSON.stringify(data)
    $.each(data, function(){
        $("#tag_thirdLevelParent").append('<option value="'+ this.id +'">'+ this.name +'</option>')
    })
    // for ( var i = 0; i < data.length; i++ ){
    //   alert("child: " + data[i].name)
    //   // $('#dbi_engine_config_' + column).attr('value', dbi_engine[column]);
    // }

  }

  function addFirstLevel() {
    $('#firstLevel').show();
    $('#secondLevel').hide();
    $('#thirdLevel').hide();
    $('#save_kp').enable
    $('#current_action').val("firstLevelAction")

    // alert("current action:" + $('#current_action').val())
  }

  function addSecondLevel() {
    $('#firstLevel').hide();
    $('#secondLevel').show();
    $('#thirdLevel').hide();
    $('#current_action').val("secondLevelAction");
    // alert("current action:" + $('#current_action').val())
  }

  function addThirdLevel() {
    $('#firstLevel').hide();
    $('#secondLevel').hide();
    $('#thirdLevel').show();
    $('#current_action').val("thirdLevelAction")

    // alert("current action:" + $('#current_action').val())
  }
</script>
